<?php

/**
 * @file
 * Module file for equipment_tracking module.
 */

use Drupal\views\ViewExecutable;

/**
 * Implements hook_theme().
 */
function equipment_tracking_theme() {
  return [
    'aleph_equipment_available' => [
      'variables' => [
        'equipment_count' => '',
        'equipment_sysnum' => '',
        'equipment_mindue' => '',
        'error' => '',
      ],
    ],
  ];
}


/**
 * Implements hook_form_views_exposed_form_alter().
 *
 * This should maintain facets across searches.
 *
 * @see
 *   https://www.drupal.org/project/facets/issues/2767389
 */
function equipment_tracking_form_views_exposed_form_alter(&$form, $form_state, $form_id) {
  $params = \Drupal::requestStack()->getCurrentRequest()->query->all();
  $facet_manager = \Drupal::service('facets.manager');
  $facets = $facet_manager->getEnabledFacets();
  foreach ($facets as $facet) {
    $filter_keys[] = empty($facet->getFacetSourceConfig()->getFilterKey()) ? 'f' : $facet->getFacetSourceConfig()->getFilterKey();

  }
  if (!empty($filter_keys)) {
    foreach (array_unique($filter_keys) as $filter_key) {
     if (!empty($params[$filter_key]) && !empty($param_values = $params[$filter_key])) {
        // Add facet parameters to hidden fields in the forms.
        foreach ($param_values as $key => $value) {
          $form[$filter_key . '[' . $key . ']'] = [
            '#type' => 'hidden',
            '#value' => $value,
          ];
        }
      }
    }
  }
}

/**
* Implements hook_views_pre_render().
*/
function equipment_tracking_views_pre_render(ViewExecutable $view) {
  if (empty($view) || empty($view->storage->id())) {
    return;
  }
  if ($view->storage->id() == 'equipment_tracking') {
    $view->element['#attached']['library'][] = 'equipment_tracking/equipment-tracking';
  }
}
